<h2><%= @dream.title %></h2>

<%= simple_format @dream.story %>

<p>Dreamt up by <%= link_to @dream.dreamer, @dream.dreamer %></p>

<% if signed_in? %>
  <% if current_user.has_rated?(@dream) %>
    <p>You have rated this dream.</p>
  <% else %>
    <% form_for([current_user, Rating.new]) do |form| %>
      <%= form.hidden_field :dream_id, :value => @dream.id %>
      <%= form.submit 'Rate It!' %>
    <% end %>
  <% end %>
<% else %>
  <p><%= link_to 'Sign in', sign_in_path %> or <%= link_to 'Sign up', sign_up_path %> to rate this dream.</p>
<% end %>

<% if @dream.appearances.any? %>
  <h3>Featuring Appearances From...</h3>
  <ul>
  <% @dream.appearances.each do |app| %>
    <% if app.apparition %>
      <li><%= link_to app.name, app.apparition %></li>
    <% else %>
      <li><%= app.name %></li>
    <% end %>
  <% end %>
  </ul>
<% end %>

<h3>Comments</h3>

<% if @dream.available_comments.any? %>
<ul>
  <% @dream.available_comments.each do |comment| %>
  <li>
    <h4><%= comment.dreamer %> said on <%= comment.created_at.to_date %></h4>
    <p><%= comment.body %></p>
    <% if signed_in? %>
      <p><%= link_to 'Report this?', new_dream_comment_report_path(@dream, comment) %></p>
    <% else %>
      <%= link_to 'Sign up', sign_up_path %> or <%= link_to 'sign in', sign_in_path %> to report inappropriate comments
    <% end %>
  </li>
  <% end %>
</ul>
<% else %>
  <p>No comments yet</p>
<% end %>

<% if signed_in? %>
  <% form_for([@dream, Comment.new]) do |form| %>
  <fieldset>
    <legend>Your Comment</legend>
    <p>
      <%= form.label :body, 'Comment' %>
      <%= form.text_area :body %>
    </p>
    <p>
      <%= form.submit 'Add Comment' %>
    </p>
  </fieldset>
  <% end %>
<% else %>
  <p>You must be signed in to comment. <%= link_to 'Sign in now', sign_in_path(:return_to => dream_path(@dream)) %></p>
<% end %>


<% if signed_in? and current_user == @dream.dreamer %>
  <p><%= link_to 'Edit', edit_dream_path(@dream) %></p>
<% end %>

<p><%= link_to 'Browse Dreams', dreams_path %></p>

<% content_for :extra_headers do %>
<script type="text/javascript" charset="utf-8">
  // var rating_error_handler = function () {
  //   alert('this?');
  // }
  $(document).ready(function () {
    $('#new_rating').submit(function () {
      $.ajax({
        type: "POST",
        url: this.action + ".js",
        data: $(this).serialize(),
        dataType: "script",
        // error: rating_error_handler,
        success: function(msg) {
          $(this).html("<p>You have rated this dream.</p>");
          $('#flash').append('<div class="flash" id="flash_notice">Rating was successfully created.</div>');
          $('#flash_notice').hide(1800);
        }
      });
      
      return false;
    });
  });
</script>
<% end %>